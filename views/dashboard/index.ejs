<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.7.32/sweetalert2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
    <div id="userData" data-role="<%= user.role %>" data-line="<%= user.line_number || '' %>" style="display: none;"></div>
    
    <header class="dashboard-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <img src="/image/Logo sanoh 2 2.png" alt="Sanoh Logo" class="logo-img">
                    <h1 class="dashboard-title">Andon Dashboard</h1>
                </div>
                <div class="status-info">
                    <div class="top-row-info"> 
                        <div class="user-info">
                            <i class="fas fa-user"></i>
                            <span><%= user.name %></span>
                        </div>
                        <div class="nav-links"> 
                            <% if (user.role === 'admin') { %>
                                <a href="/analytics" class="analytics-link" title="Analytics Dashboard">
                                    <i class="fas fa-chart-line"></i>
                                    <span>Analytics</span>
                                </a>
                                <a href="/plc-monitoring" class="analytics-link" title="PLC Monitoring">
                                    <i class="fas fa-network-wired"></i>
                                    <span>PLC</span>
                                </a>
                                <a href="/users" class="analytics-link" title="User Management">
                                    <i class="fas fa-users-cog"></i>
                                    <span>Users</span>
                                </a>
                                <a href="/inspect-tables" class="analytics-link" title="Manage Inspect Tables">
                                    <i class="fas fa-table"></i>
                                    <span>Manage Tables</span>
                                </a>
                            <% } %>
                        </div>
                        <form method="POST" action="/logout" style="display: inline; margin-left: 10px;">
                            <button type="submit" class="logout-btn" title="Logout">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </form>
                    </div>
                    <div class="bottom-row-status">
                        <div class="connection-status" id="connectionStatus">
                            <i class="fas fa-wifi"></i>
                            <span>Connected</span>
                        </div>
                        <div class="last-update">
                            Last Update: <span id="lastUpdate">--:--:--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="dashboard-main">
        <div class="container">
            <div class="stats-section" id="globalStats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-industry"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-number" id="totalMachines">0</div>
                        <div class="stat-label">Total Meja</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon critical">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-number" id="activeProblems">0</div>
                        <div class="stat-label">Problem Aktif</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-number" id="resolvedToday">0</div>
                        <div class="stat-label">Resolved Hari Ini</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-number" id="criticalProblems">0</div>
                        <div class="stat-label">Critical Problems</div>
                    </div>
                </div>
            </div>

            <% 
                const sortedLineNumbers = Object.keys(machinesByLine).sort((a, b) => a - b);
                sortedLineNumbers.forEach(lineNumber => {
            %>
                <% 
                    const shouldDisplayLine = user.role === 'admin' || 
                                              user.role === 'maintenance' || 
                                              user.role === 'quality' || 
                                              user.role === 'warehouse' || 
                                              (user.role === 'leader' && user.line_number == lineNumber);
                %>

                <% if (shouldDisplayLine) { %>
                    <section class="line-section" data-line-number="<%= lineNumber %>">
                        <h2 class="line-header">Status Line <%= lineNumber %></h2>
                        <div class="machines-grid" id="line-<%= lineNumber %>-machines">
                            <% machinesByLine[lineNumber].forEach(machine => { %>
                                <div class="machine-card" data-machine="<%= machine.name %>" data-line="<%= machine.line_number %>" onclick="showProblemDetail('<%= machine.name %>', '<%= machine.id %>')">
                                    <div class="machine-header">
                                        <h3><%= machine.name %></h3>
                                        <div class="machine-indicator">
                                            <div class="indicator-light <%= machine.status %>" id="light-<%= machine.name.replace(/ /g, '') %>">
                                                <div class="pulse-ring"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="machine-info">
                                        <div class="status-text <%= machine.status %>" id="status-<%= machine.name.replace(/ /g, '') %>">
                                            <% if (machine.status === 'problem') { %>
                                                <i class="fas fa-exclamation-triangle"></i><span>Problem - <%= machine.problem_type || 'Unknown' %></span>
                                            <% } else { %>
                                                <i class="fas fa-check-circle"></i><span>Normal Operation</span>
                                            <% } %>
                                        </div>
                                        
                                        <div class="machine-details">
                                            <div class="detail-item quantity-info">
                                                <span class="label"><i class="fas fa-box"></i> Quantity:</span>
                                                <span class="value" id="quantity-<%= machine.name.replace(/ /g, '') %>"><%= machine.quantity !== undefined ? machine.quantity : '0' %></span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="label">Last Check:</span>
                                                <span class="value" id="lastcheck-<%= machine.name.replace(/ /g, '') %>"><%= moment(machine.last_check).format('HH:mm:ss') %></span>
                                            </div>
                                            <div class="detail-item problem-info <%= (machine.status === 'problem' && machine.problem_type) ? '' : 'hidden' %>" id="problem-<%= machine.name.replace(/ /g, '') %>">
                                                <span class="label">Problem:</span>
                                                <span class="value problem-type-value"><%= machine.problem_type || 'N/A' %></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    </section>
                <% } %>
            <% }) %>

            <div class="problems-section">
                <h2>Daftar Problem Aktif (<span id="activeProblemCount">0</span>)</h2>
                <div class="problems-list" id="problemsList">
                    <div class="no-problems" id="noProblems" style="display: block;">
                        <i class="fas fa-check-circle"></i>
                        <p>Tidak ada problem aktif saat ini</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="modal" id="problemModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Detail Problem</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Tutup</button>
                <button class="btn btn-primary" id="resolveBtn" onclick="resolveProblem()">Tandai Resolved</button>
            </div>
        </div>
    </div>

    <audio id="alertSound" preload="auto">
        <source src="/audio/alert.mp3" type="audio/mpeg">
    </audio>

    <audio id="succesSound" preload="auto">
        <source src="/audio/success.mp3" type="audio/mpeg">
    </audio>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.7.32/sweetalert2.min.js"></script>
    <script src="/js/dashboard.js"></script>
</body>
</html>